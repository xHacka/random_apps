{% extends 'log_analyzer/base.html' %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="p-6">
        <div class="mb-6">
            <h2 class="text-lg font-medium text-gray-900">Filter Logs</h2>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for field in fields %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                    {% if field.type == 'choice' %}
                    <label class="block text-sm font-medium text-gray-700">HTTP Methods</label>
                    <select name="{{ field.name }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-md focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                        <option value="">All</option>
                        {% for choice in field.choices %}
                        <option value="{{ choice }}">{{ choice }}</option>
                        {% endfor %}
                    </select>
                    {% elif field.type == 'datetime' %}
                    <input type="date" name="{{ field.name }}"
                        class="w-full px-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
                    {% else %}
                    <input type="{{ field.type }}" name="{{ field.name }}" placeholder="Enter {{ field.label }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-md focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="mt-4">
                <button onclick="filterLogs(1)"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    Apply Filters
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Path</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="bg-white divide-y divide-gray-200">
                    <!-- Dynamically populated -->
                </tbody>
            </table>
        </div>

        <div id="pagination" class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-700">
                Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span
                    id="totalEntries">0</span> entries
            </div>
            <div class="flex space-x-2">
                <button id="prevPage" onclick="previousPage()"
                    class="px-3 py-1 border rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50">
                    Previous
                </button>
                <span id="currentPage" class="px-3 py-1 border rounded bg-indigo-50">1</span>
                <button id="nextPage" onclick="nextPage()"
                    class="px-3 py-1 border rounded text-sm text-gray-600 hover:bg-gray-50 disabled:opacity-50">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let totalPages = 1;

    function formatDate(dateString) {
        return new Date(dateString).toLocaleString();
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function filterLogs(page = 1) {
        currentPage = page;
        const params = new URLSearchParams();
        params.append('page', page);

        document.querySelectorAll('input, select').forEach(element => {
            if (element.value) {
                params.append(element.name, element.value);
            }
        });

        fetch(`/api/filter/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('logsTable');
                table.innerHTML = '';

                data.data.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(log.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ip_address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.request_method}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.path}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.status_code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatBytes(log.response_size)}</td>
                `;
                    table.appendChild(row);
                });

                totalPages = data.pages;
                updatePagination(data.total);
            });
    }

    function updatePagination(total) {
        const perPage = 50;
        const start = ((currentPage - 1) * perPage) + 1;
        const end = Math.min(currentPage * perPage, total);

        document.getElementById('startRange').textContent = start;
        document.getElementById('endRange').textContent = end;
        document.getElementById('totalEntries').textContent = total;
        document.getElementById('currentPage').textContent = currentPage;

        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    function previousPage() {
        if (currentPage > 1) {
            filterLogs(currentPage - 1);
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            filterLogs(currentPage + 1);
        }
    }

    // Initial load
    filterLogs(1);
</script>
{% endblock %}